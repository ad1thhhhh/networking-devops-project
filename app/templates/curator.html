{% extends "base.html" %}
{% block content %}

<div class="space-y-14 animate-fadeIn">

{% set total = tasks|length %}
{% set completed = tasks|selectattr("completed")|list|length %}
{% set active = total - completed %}

<div>
    <h1 class="text-4xl font-bold text-white">Curator Dashboard</h1>
    <p class="text-gray-400 mt-2">Executive overview of artisan workflow.</p>
</div>

<!-- KPI CARDS -->
<div class="grid md:grid-cols-3 gap-8">

    <div class="bg-white/5 p-8 rounded-3xl border border-white/10">
        <p class="text-gray-400">Total Tasks</p>
        <h2 class="text-5xl font-bold counter" data-target="{{ total }}">0</h2>
    </div>

    <div class="bg-white/5 p-8 rounded-3xl border border-white/10">
        <p class="text-gray-400">Completed</p>
        <h2 class="text-5xl font-bold counter" data-target="{{ completed }}">0</h2>
    </div>

    <div class="bg-white/5 p-8 rounded-3xl border border-white/10">
        <p class="text-gray-400">Progress</p>
        <h2 class="text-5xl font-bold">{{ progress|round(0) }}%</h2>
    </div>

</div>

<!-- CHART -->
<div class="bg-white/5 p-8 rounded-3xl border border-white/10">
    <canvas id="taskChart"></canvas>
</div>

<!-- MODAL BUTTON -->
<div class="text-right">
    <button onclick="openModal()" class="px-8 py-4 rounded-2xl bg-indigo-600 hover:scale-105 transition">
        + New Task
    </button>
</div>

<!-- TASK LIST -->
<div class="space-y-4">
{% for task in tasks %}
    <div class="bg-white/5 p-6 rounded-2xl border border-white/10 flex justify-between">
        <span class="{% if task.completed %}line-through text-gray-500{% endif %}">
            {{ task.title }}
        </span>
        <span class="{% if task.completed %}text-green-400{% else %}text-yellow-400{% endif %}">
            {% if task.completed %}Completed{% else %}Active{% endif %}
        </span>
    </div>
{% endfor %}
</div>

</div>

<!-- MODAL -->
<div id="taskModal" class="fixed inset-0 hidden items-center justify-center bg-black/60">
    <div class="bg-[#0f172a] p-10 rounded-3xl w-full max-w-md">
        <form method="POST" class="space-y-6">
            <input type="text" name="task" required placeholder="Task..."
                class="w-full px-4 py-3 rounded-xl bg-black/40 border border-gray-700">
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded-xl">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 rounded-xl">Create</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

    // Counter Animation
    document.querySelectorAll(".counter").forEach(counter => {
        const target = +counter.dataset.target;
        let count = 0;
        const update = () => {
            const inc = target / 40;
            if (count < target) {
                count += inc;
                counter.innerText = Math.ceil(count);
                requestAnimationFrame(update);
            } else {
                counter.innerText = target;
            }
        };
        update();
    });

    // Chart
    new Chart(document.getElementById("taskChart"), {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Active'],
            datasets: [{
                data: [{{ completed }}, {{ active }}],
                backgroundColor: ['#22c55e', '#6366f1'],
                borderWidth: 0
            }]
        },
        options: { cutout: '70%' }
    });

    // Streak
    let streak = localStorage.getItem("streak") || 0;
    if ({{ completed }} > 0) {
        streak++;
        localStorage.setItem("streak", streak);
    }

});

function openModal() {
    document.getElementById("taskModal").classList.remove("hidden");
    document.getElementById("taskModal").classList.add("flex");
}

function closeModal() {
    document.getElementById("taskModal").classList.add("hidden");
    document.getElementById("taskModal").classList.remove("flex");
}
</script>

{% endblock %}
